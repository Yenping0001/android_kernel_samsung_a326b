name: Build Single Kernel Module

on:
  workflow_dispatch:
    inputs:
      module_dir:
        description: 'Directory of the module (e.g., drivers/video/fbdev)'
        required: true
        default: 'drivers/staging/android'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential python3 curl git zip \
          libssl-dev libffi-dev flex bison libelf-dev libncurses-dev

      - name: Clone Toolchains
        run: |
          # Links from your config.sh
          git clone --depth=1 https://github.com/H33CKER/toolchains -b gcc-4.9 ./gcc
          git clone --depth=1 https://github.com/H33CKER/toolchains -b clang-12 ./clang

      - name: Build Module
        run: |
          # Setup Environment
          export ARCH=arm64
          export SRC=$(pwd)
          export OUT_DIR=$SRC/out
          export CROSS_COMPILE=$SRC/gcc/bin/aarch64-linux-androidkernel-
          export CC=$SRC/clang/bin/clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export PATH=$SRC/clang/bin:$SRC/gcc/bin:$PATH
          
          mkdir -p $OUT_DIR

          # 1. Initialize config
          make -C $SRC O=$OUT_DIR a32x_defconfig

          # 2. Prepare headers/scripts (Required for standalone module build)
          make -C $SRC O=$OUT_DIR -j$(nproc) modules_prepare

          # 3. Build only the specific directory
          make -C $SRC O=$OUT_DIR -j$(nproc) M=${{ github.event.inputs.module_dir }}

      - name: Upload .ko Files
        uses: actions/upload-artifact@v4
        with:
          name: compiled-modules
          path: out/${{ github.event.inputs.module_dir }}/*.ko
          
