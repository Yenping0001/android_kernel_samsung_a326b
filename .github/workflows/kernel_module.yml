name: Build Mediatek Module

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential python3 curl git zip \
          libssl-dev libffi-dev flex bison libelf-dev libncurses-dev

      - name: Clone Toolchains
        run: |
          git clone --depth=1 https://github.com/H33CKER/toolchains -b gcc-4.9 ./gcc
          git clone --depth=1 https://github.com/H33CKER/toolchains -b clang-12 ./clang

      - name: Build Module
        run: |
          # Load Environment (from your config.sh logic)
          export ARCH=arm64
          export SRC=$(pwd)
          export OUT_DIR=$SRC/out
          export CROSS_COMPILE=$SRC/gcc/bin/aarch64-linux-androidkernel-
          export CC=$SRC/clang/bin/clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export PATH=$SRC/clang/bin:$SRC/gcc/bin:$PATH
          
          mkdir -p $OUT_DIR

          # 1. Setup Config
          make -C $SRC O=$OUT_DIR a32x_defconfig

          # 2. IMPORTANT: Force enable the module as 'm' if it's not set
          # This ensures it generates a .ko instead of being built into the kernel
          scripts/config --file $OUT_DIR/.config --enable CONFIG_MTK_CONN_FEM
          # (Replace CONFIG_MTK_CONN_FEM with the actual config name for your driver)

          # 3. Prepare for building
          make -C $SRC O=$OUT_DIR -j$(nproc) modules_prepare

          # 4. Build the specific Mediatek path
          make -C $SRC O=$OUT_DIR -j$(nproc) M=drivers/misc/mediatek/connectivity

      - name: Check for .ko Files
        run: |
          echo "Listing found modules:"
          find out/drivers/misc/mediatek/connectivity -name "*.ko"

      - name: Upload .ko Files
        uses: actions/upload-artifact@v4
        with:
          name: MTK-Modules
          path: out/drivers/misc/mediatek/connectivity/**/*.ko
          
