name: Build MTK WLAN Module

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential python3 curl git zip \
          libssl-dev libffi-dev flex bison libelf-dev libncurses-dev

      - name: Clone Toolchains
        run: |
          # Toolchains from your config.sh
          git clone --depth=1 https://github.com/H33CKER/toolchains -b gcc-4.9 ./gcc
          git clone --depth=1 https://github.com/H33CKER/toolchains -b clang-12 ./clang

      - name: Build Module
        run: |
          # Environment Setup
          export ARCH=arm64
          export SRC=$(pwd)
          export OUT_DIR=$SRC/out
          export CROSS_COMPILE=$SRC/gcc/bin/aarch64-linux-androidkernel-
          export CC=$SRC/clang/bin/clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export PATH=$SRC/clang/bin:$SRC/gcc/bin:$PATH
          
          mkdir -p $OUT_DIR

          # 1. Generate the .config file (Fixes the screenshot error)
          make -C $SRC O=$OUT_DIR a32x_defconfig

          # 2. Prepare the build environment (Fixes the missing auto.conf error)
          make -C $SRC O=$OUT_DIR -j$(nproc) modules_prepare

          # 3. Build specifically the WLAN directory
          # We target the subfolder directly to find the .ko
          make -C $SRC O=$OUT_DIR -j$(nproc) M=drivers/misc/mediatek/connectivity/wlan_drv_gen4m modules

      - name: Find and Upload .ko
        run: |
          echo "Searching for wlan_drv_gen4m.ko..."
          find out -name "wlan_drv_gen4m.ko"
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wlan-module
          path: out/**/*.ko
          
