name: Build Specific Kernel Module

on:
  workflow_dispatch:
    inputs:
      module_path:
        description: 'Path to module (e.g., drivers/video/fbdev)'
        required: true
        default: 'drivers/staging/example'

jobs:
  build_module:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential python3 curl git zip \
          libssl-dev libffi-dev flex bison libelf-dev libncurses-dev

      - name: Setup Toolchains
        run: |
          # Cloning toolchains as defined in your config.sh
          git clone --depth=1 https://github.com/H33CKER/toolchains -b clang-12 ./clang
          git clone --depth=1 https://github.com/H33CKER/toolchains -b gcc-4.9 ./gcc

      - name: Build Module
        run: |
          # Define environment variables from your config.sh
          export ARCH=arm64
          export SRC=$(pwd)
          export OUT_DIR=$SRC/out
          export CROSS_COMPILE=$SRC/gcc/bin/aarch64-linux-androidkernel-
          export CC=$SRC/clang/bin/clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export PATH=$SRC/clang/bin:$SRC/gcc/bin:$PATH
          
          mkdir -p $OUT_DIR

          # 1. Generate the base configuration
          make -C $SRC O=$OUT_DIR a32x_defconfig

          # 2. Build ONLY the specific module
          # We use the input from the 'workflow_dispatch'
          make -C $SRC O=$OUT_DIR -j$(nproc) M=${{ github.event.inputs.module_path }}

      - name: Upload Module Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-modules
          # This finds all .ko files in the specific output path
          path: out/${{ github.event.inputs.module_path }}/*.ko

