name: Build Wi-Fi Module

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-kernel-module:
    runs-on: ubuntu-latest  # The distribution to run on
    permissions:
      contents: write

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          path: kernel_source

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc flex bison libssl-dev libelf-dev

      - name: Build WILC1000 Modules
        run: |
          cd $GITHUB_WORKSPACE/kernel_source
          
          # 1. Generate the kernel configuration
          # Note: Replace 'defconfig' with your device's specific config if known
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- defconfig
          
          # 2. Prepare headers and scripts for module compilation
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- modules_prepare
          
          # 3. Compile only the WILC1000 driver folder
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- \
            CONFIG_WILC1000=m \
            CONFIG_WILC1000_SDIO=m \
            M=drivers/staging/wilc1000 modules

      - name: Prepare Modules for Upload
        run: |
          mkdir -p output_modules
          # Find the built .ko file in the staging directory
          find kernel_source/drivers/staging/wilc1000 -name "*.ko" -exec cp {} output_modules/ \;
          ls -R output_modules/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: output_modules/*.ko
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
