name: Build Wi-Fi Module

on:
  workflow_dispatch: # Allows manual trigger from the Actions tab
  push:
    tags:
      - 'v*' # Triggers when you push a tag like v1.0

jobs:
  build-kernel-module:
    runs-on: ubuntu-latest  # This is the "Distribution" (Latest Ubuntu Linux)
    
    permissions:
      contents: write # Required to upload files to the Release section

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          path: kernel_source # Ensures the folder is named kernel_source

      - name: Set up Toolchain
        run: |
          # You need to ensure your cross-compiler (aarch64) is installed here
          # Usually, you would download the Android NDK or a specific GCC/Clang toolchain
          sudo apt-get update
          sudo apt-get install -y build-essential bc flex bison libssl-dev

      - name: Build WILC1000 Modules
        run: |
          cd $GITHUB_WORKSPACE/kernel_source
          # We enable the driver as a module
          # and set the SDIO interface standard for mobile
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- \
            CONFIG_WILC1000=m \
            CONFIG_WILC1000_SDIO=m \
            M=drivers/staging/wilc1000 modules

      - name: Prepare Modules for Upload
        run: |
          mkdir -p output_modules
          # Search for the newly created .ko files
          find kernel_source/drivers/staging/wilc1000 -name "*.ko" -exec cp {} output_modules/ \;
          ls -R output_modules/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            output_modules/*.ko
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
